from .BasePrompt import BasePrompt
# This query uses the assistants API instead
class TrajectoryQuery(BasePrompt): 
    def __init__(self) -> None:
        '''
            scene_graph: scene graph of the location in text-serialized format.
            llm_scenario_out: output of the scenario generated by llm, parsed into a dictionary.
        '''
        super().__init__()
        self.required_output_keys = ['reasoning','trajectories','groupids']
        self.payload = [{"role": "system", 
     "content": [{
         "type":"text",
         "text":"""
        You are an expert floor planner and a software engineer. You ALWAYS provide output that in JSON which is fully parseable with json.loads in python.
         """}]
     },
{"role": "user", 
     "content": [{
         "type":"text",
         "text":f"""
The image shows a location which is represented by a scene graph. A scene graph is a graph with nodes (numbered red circles) representing locations and edges (blue lines) connecting them. 
A person/ can only move from one node to another if the two nodes are connected by an edge. 
The scene graph in json file format is also given below, where each node and edge has a unique id, a type, the pixel position of the node in the image (pos). 
<SCENE GRAPH>
The type of a node is one among: <NODE TYPES> while the edges are one among: <EDGE TYPES>. 
The graph is bidirectional and each edge is also represented with the edge list 'links' in the json given below.  
Remember that a node can only be reached from another node if they have an edge between them in the scene graph json.
Now answer the following questions below:
Is node 0e connected to node 07?
Return an answer in JSON format shown below:"""+"""
{
    'ANSWER': True/False,
    'REASONING': <Reasoning for answer>
}
"""},
     {         
        "type":"image_url",
        "image_url":{
            "url":"data:image/jpeg;base64,{<ENCODED IMAGE>}",
            "detail":"high"
        }
     }]
     },
{"role": "assistant", "content": [{"type":"text","text":"""
{
    'ANSWER': False
    'REASONING': ""To determine if node "0e" is connected to node "07," we need to trace the paths in the provided edges.
Nodes:
"0e" at position [80, 660] (type: CORNER)
"07" at position [28, 318] (type: CORNER)
Edges involving "0e":
{"type": "PASSAGEWAY", "source": "0e", "target": "32"}
{"type": "PASSAGEWAY", "source": "0e", "target": "cb"}
Edges involving "07":
{"type": "NARROW PASSAGEWAY", "source": "11", "target": "07"}
{"type": "PASSAGEWAY", "source": "07", "target": "f7"}
There are no direct or indirect edges connecting "0e" to "07" through other nodes. Therefore, node "0e" is not connected to node "07" "".
}
"""
}]},
{"role": "user", "content": [{"type":"text","text":"""If I walk from node d9 to node aa and take a left turn which node will I reach first?
Return an answer in JSON format shown below:"""+"""
{
    'Answer': Node ID,
    'Reasoning': <Reasoning for answer>
}"""}]},
{"role": "assistant", "content": [{"type":"text",
"text":"""{
    
'ANSWER': "47",

'REASONING':"
    To determine which node you will reach first if you walk from node "d9" to node "aa" and then take a left turn, we need to look at the nodes connected to "aa" and identify the left turn from "aa".
    From the JSON structure:
    Node "aa" is connected to:
    Node "d9"
    Node "47"
    Node "69"
    Node "99"
    Since you're starting from node "d9" and reaching node "aa", taking a left turn would typically mean turning towards the next node that is positioned to the left relative to your current direction of movement. Based on the provided positions and assuming you're facing north when reaching "aa" from "d9":
    "d9" to "aa" positions: (339, 317) to (507, 319) indicates you're moving east.
    A left turn from this direction would point you north.
    Among the connected nodes to "aa", the one positioned north (left turn) is "47":
    "47" position: [503, 148]
    Therefore, if you walk from node "d9" to node "aa" and take a left turn, you will first reach node "47"."
    }"""
}]},
{"role": "user", "content": [{"type":"text","text":"""If I walk from node ba to node 69, which direction am I walking?
                              Return an answer in JSON format shown below:"""+"""
{
    'Answer': DIRECTION,
    'Reasoning': <Reasoning for answer>
}"""}]},
{"role": "assistant", "content": [{"type":"text","text":"""
                                   
{   
    'ANSWER': 'NORTH-WEST',
    'REASONING': ""To determine the direction you are walking when moving from node "ba" to node "69", we can look at the positions of these nodes in the JSON structure.
Node positions:
Node "ba": [790, 667]
Node "69": [686, 501]
Given these coordinates:
Node "ba" is located at (790, 667)
Node "69" is located at (686, 501)
Calculating the Direction:
The x-coordinate decreases from 790 to 686.
The y-coordinate decreases from 667 to 501.
Since both the x and y coordinates are decreasing, you are moving in a direction that is generally north-west.
Direction Analysis:
A decrease in the x-coordinate indicates movement towards the west.
A decrease in the y-coordinate indicates movement towards the north.
Conclusion:
When walking from node "ba" to node "69", you are walking in a north-west direction.""
}
"""}]},
{"role": "user", "content": [{"type":"text","text":"""If I walk from node 79 to node 99, which direction should I turn to reach node e3?
Return an answer in JSON format shown below:"""+"""
{
    'Answer': DIRECTION,
    'Reasoning': <Reasoning for answer>
}"""}]},
{"role": "assistant", "content": [{"type":"text","text":"""
{
    'Answer': 'left (east)',
    'REASONING': ""To determine the direction you should turn to reach node "e3" after walking from node "79" to node "99," we need to look at the relative positions of these nodes.
Node positions:
Node "79": [883, 133]
Node "99": [893, 315]
Node "e3": [1124, 309]
Movement Analysis:
Walking from node "79" to node "99":
"79" is located at (883, 133).
"99" is located at (893, 315).
Moving from "79" to "99" involves primarily moving south (as the y-coordinate increases significantly more than the x-coordinate).
Determining the direction to node "e3" from node "99":
"99" is located at (893, 315).
"e3" is located at (1124, 309).
Moving from "99" to "e3" involves primarily moving east (as the x-coordinate increases significantly and the y-coordinate remains almost the same).
Conclusion:
After walking south from "79" to "99", you should turn left (east) to reach node "e3".""
}

"""}]}]
        
        scenario_1 = [{"role": "user", "content": [
    {"type":"text",
     "text":"""
Let's initialize a simulator (like Gazebo) with the world given in the image and described by the json file and try to orchestrate the following human-robot scenario: 
        
Robot is transporting a box from one point to another in the warehouse. While moving along a passageway, it encounters an employee walking in the opposite direction.

You must select the trajectories of the humans and the robot to orchestrate this scenario. You must also assign integer group ids to the HUMANS ONLY involved in the scenario according to the 
following rule:
1. All the members of the same group must have the same group id.
2. If a human is not involved in a group, they will have a group id of -1.
3. If the scenario does not specifically mention a group, then assign -1 to all humans
4. All humans involved in the scenario must be assigned a group id.
Format your output in json as given below:
        {
            'REASONING': <Reasoning for Answer>,
            'TRAJECTORIES': {
                'ROBOT': <...>
                'HUMAN 1': <...>,
                'HUMAN 2': <...>,
                'HUMAN 3': <...>,
            },
            'GROUP ID':{
                'HUMAN 1': ..,
                'HUMAN 2': ...,
                ...
            }
        }"""
}]},
{"role": "assistant", "content": [{"type":"text","text":"""
{
'REASONING':""To create a scenario where robot is transporting a box from one point to another in the warehouse and encounters an employee walking in the opposite direction along a passageway, we need to identify a suitable passageway and ensure that robot and the employee move towards each other from opposite directions.

        ### Scenario Setup:
        1. robot starts at one node and moves along a passageway towards a destination node.
        2. An employee starts at the destination node and moves along the same passageway towards robot.

        ### Suggested Passageway:
        We'll use the passageway between nodes "07", "f7", and "d9" again as it is a straightforward path that allows for clear movement in opposite directions.

        ### robot's Trajectory:
        1. **Start at node "f7"** (robot picks up the box here)
        2. **Move to node "07"** (robot moves along the passageway)

        ### Employee's Trajectory:
        1. **Start at node "07"**
        2. **Move to node "f7"** (The employee moves along the same passageway towards robot)

        ### Detailed Node Sequence:

        #### robot's Nodes:
        1. f7
        2. 07

        #### Employee's Nodes:
        1. 07
        2. f7

        ### Path Visualization:
        - **robot's Path**: f7 → 07
        - **Employee's Path**: 07 → f7

        ### Simulator Initialization:
        - **robot** starts at node "f7" and follows the path f7 → 07.
        - **Employee** starts at node "07" and follows the path 07 → f7.

        Since there is only one human in the scenario and the human is not involved in any groups, the group id for this human is the default -1.

        In a simulator like Gazebo, you can set up the initial positions of robot and the employee at their respective starting nodes and let them move along the described paths. They will encounter each other along the passageway between nodes "f7" and "07". 

        ### Steps to Simulate:
        1. Initialize robot at node "f7" with a box.
        2. Initialize the employee at node "07".
        3. Set both to move towards each other along the passageway.

        This will create the scenario where robot, while transporting a box, encounters an employee walking in the opposite direction along the same passageway."",                                
'TRAJECTORIES': {
    'ROBOT': ['f7','07']
    'HUMAN 1': ['07','f7'],
},
'GROUP ID':{
    'HUMAN 1': -1
}
                            }                        
"""}]}]
        
        scenario_2 = [
{"role": "user", "content":[{"type":"text","text":"""
Now generate trajectories for the following scenario: 
                             
The robot starts at an intersection and needs to transport a box to another intersection on the other side of the warehouse. As it navigates through passageways and intersections, it reaches an open area where two warehouse employees are standing and talking. The open area is halfway through the robot's planned route.
        
You must select the trajectories of the humans and the robot to orchestrate this scenario. You must also assign integer group ids to the HUMANS ONLY involved in the scenario according to the following rule:
1. All the members of the same group must have the same group id.
2. If a human is not involved in a group, they will have a group id of -1.
3. All humans involved in the scenario must be assigned a group id.
Format your output in json as given below:
        {
           'REASONING': <Reasoning for Answer>,
             'TRAJECTORIES': {
                'ROBOT': <...>
                'HUMAN 1': <...>,
                'HUMAN 2': <...>,
                'HUMAN 3': <...>,
            },
            'GROUP IDS':{
                'HUMAN 1': ..,
                'HUMAN 2': ...,
                ...
            }
}"""
}]},
{"role": "assistant", "content": [{"type":"text","text":"""
{                                   
'REASONING':""To create the scenario where a robot starts at an intersection, transports a box to another intersection on the other side of the warehouse, and encounters two employees standing and talking in an open area halfway through its route, we need to carefully plan the robot's trajectory and identify a suitable open area for the employees.

    ### Scenario Setup:
    1. The robot starts at an intersection.
    2. The robot's destination is another intersection on the other side of the warehouse.
    3. The robot navigates through passageways and intersections.
    4. The robot reaches an open area halfway through its route where two employees are standing and talking.

    ### Selected Intersections and Open Area:
    - **Start Intersection**: Node "f7"
    - **Destination Intersection**: Node "e3"
    - **Open Area (halfway point)**: Node "69"

    ### Robot's Trajectory:
    1. **Start at node "f7"**.
    2. **Move to node "d9"** (intersection).
    3. **Move to node "aa"** (intersection).
    4. **Move to node "69"** (open area, halfway point where the employees are).
    5. **Move to node "cf"** (intersection).
    6. **Move to node "e3"** (destination intersection).

    ### Detailed Node Sequence for the Robot:
    1. f7
    2. d9
    3. aa
    4. 69
    5. cf
    6. e3

    ### Positioning the Employees:
    - Employees will be standing at node "69".
    - Since the employees, Human 1 and Human 2 form a group, they are given the same integer group id. Let's assign 1 to both their group ids.
    ### Path Visualization:
    - **Robot's Path**: f7 → d9 → aa → 69 → cf → e3

    ### Simulator Initialization:
    1. **Robot**:
    - Starts at node "f7".
    - Follows the path: f7 → d9 → aa → 69 → cf → e3.
    2. **Employees**:
    - Positioned at node "69" in the open area.
    - Standing and talking as the robot passes through.

    ### Steps to Simulate:
    1. Initialize the robot at node "f7" with a box.
    2. Set the robot to move along the path f7 → d9 → aa → 69 → cf → e3.
    3. Place the employees at node "69" and set their behavior to standing and talking.
    4. Monitor the robot's movement to ensure it encounters the employees at the open area (node "69").

    This setup ensures that the robot, while navigating from one intersection to another, encounters two employees standing and talking in an open area halfway through its planned route."",

'TRAJECTORIES': {
        'ROBOT': ['f7','d9','aa','69','cf','e3']
        'HUMAN 1': ['69'],
        'HUMAN 2':['69']
        },
'GROUP ID':{
    'HUMAN 1': 1,
    'HUMAN 2': 1
}, 
}"""}]},
{"role": "user", "content": [{"type":"text","text":"""Now generate trajectories for the following scenario: 
<SCENARIO DESCRIPTION>
You must select the trajectories of the humans and the robot to orchestrate this scenario. You must also assign integer group ids to the HUMANS ONLY involved in the scenario according to the following rule:
1. All the members of the same group must have the same group id.
2. If a human is not involved in a group, they will have a group id of -1.
3. If the scenario does not specifically mention a group, then assign -1 to all humans
4. All humans involved in the scenario must be assigned a group id.
Format your output in JSON as given below:
        {
            'REASONING': <Reasoning for Answer>,
            'TRAJECTORIES': {
                'ROBOT': <...>
                'HUMAN 1': <...>,
                'HUMAN 2': <...>,
                'HUMAN 3': <...>,
            },
            'GROUP IDS':{
                'HUMAN 1': ..,
                'HUMAN 2': ...,
                ...
            }
}"""}]},
]
        
        for msg in scenario_1:
            self.payload.append(msg)
        for msg in scenario_2:
            self.payload.append(msg)       
        
    def get_full_prompt(self,**kwargs):
        full_prompt = self.payload
        #add json and image to first user prompt
        full_prompt[1]["content"][0]["text"] = full_prompt[1]["content"][0]["text"].replace('<SCENE GRAPH>',kwargs['scene_graph'])
        full_prompt[1]["content"][0]["text"] = full_prompt[1]["content"][0]["text"].replace('<NODE TYPES>',kwargs['node_types'])
        full_prompt[1]["content"][0]["text"] = full_prompt[1]["content"][0]["text"].replace('<EDGE TYPES>',kwargs['edge_types'])
        full_prompt[1]["content"][1]["image_url"]["url"] = full_prompt[1]["content"][1]["image_url"]["url"].replace('<ENCODED IMAGE>',kwargs['encoded_img'])
        
        #add scenario request to last prompt
        full_prompt[-1]["content"][0]["text"] = full_prompt[-1]["content"][0]["text"].replace('<SCENARIO DESCRIPTION>',kwargs['sc_desc'])     
        return full_prompt


'''
#define scene graph APIs that GPT can use
tools = [
            {
        "type": "function",
        "function": {
                        "name": "sampleNodeOfType",
                        "description": "This function samples nodes in the graph that are of the input type. Use this to start building the trajectory for a human or the robot",
                        "parameters": {
                            "type": "object",
                            "properties": {
                                "node_type": {
                                    "type": "string",
                                    "description": "the node type to sample from the scene graph",
                                },
                            },
                            "required": ["node_type"],
                        },
                    },
            },
         {
        "type": "function",
        "function": {
                        "name": "relativeDirection",
                        "description": "This function returns the relative direction between two nodes. for example, 'right,below' means that node1 is to the right and below node2. Use this function to create consistent realistic trajectories that go in one direction.",
                        "parameters": {
                            "type": "object",
                            "properties": {
                                "node1": {
                                    "type": "string",
                                    "description": "First node",
                                },
                                "node2": {
                                    "type": "string",
                                    "description": "Second node",
                                },
                            },
                            "required": ["node1","node2"],
                        },
                    },
            },
        {
        "type": "function",
        "function": {
                        "name": "connectedNodes",
                        "description": "This function returns all the neighbouring nodes of the input node and their types and distance from the node",
                        "parameters": {
                            "type": "object",
                            "properties": {
                                "node": {
                                    "type": "string",
                                    "description": "ID of the node",
                                },
                            },
                            "required": ["node"],
                        },
                    },
            },
        
        ]
'''